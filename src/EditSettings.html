<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <title>Editing Settings</title>
  <script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const linkParam = urlParams.get('site');
  </script>
  <script src="SettingObject.js"></script>
</head>

<body>
  <script src="Header.js"></script>
<aside class="viewWindow" id="object" style="word-wrap: break-word;">
Setting Object
</aside>
  <main>
    <h1>Site Settings</h1>
    <div id="main">
        <h1>Create Settings for your Fandom Site!</h1>
        <input type="text" id="link" title="Site Link" onchange="SetLink()">
        <div id = "settings">
            <h2>What would you like the visible name to be?</h2>
            <input type="text" id="title" title="Site Title" onchange="SetTitle()">
            <br><br>
            <div class="option" id="baseSetting">
                Name of item: <input type="text" id="optionName" onchange="SetOptionName(this)"><br>
                Page to get Option Data From: <input type="text" id="source_page" onchange="SetOptionSourcePage(this)"><br>
                Type of Page: <select id="source_type" onchange="SetOptionSourceType(this)">
                    <option value="Page_Links">Links on Page</option>
                    <option value="Category">Category Listing</option>
                </select>
                <button onclick="LoadOptionStats(this)">Load Info</button><br>
                <div class="dataPoint" id ="baseDataPoint">
                    Data Name: <input type="text" id="displayName" onchange="SetDataPoint(this.parentNode)"><br>
                    Location Of Data: <select id="dataLocationType" onchange="SetDataPoint(this.parentNode)">
                        <option value="properties">Property</option>
                        <option value="page_templates">Template</option>
                    </select><br>
                    Location: <input type="text" id="dataLocation" onchange="SetDataPoint(this.parentNode)" list="0"><br>
                    Type of Data: <select id="dataType" onchange="SetDataPoint(this.parentNode)">
                        <option value="number">Number</option>
                        <option value="text">Text</option>
                        <option value="wrapped">Wrapped</option>
                    </select><br>
                    Required?: <input type="checkbox" id="dataRequired" checked onchange="SetDataPoint(this.parentNode)">
                    Default Data Value: <input type="text" id="dataDefault" onchange="SetDataPoint(this.parentNode)"><br>
                    <button onclick="RemoveDataOption(this)">Delete Data Point</button>
                </div>
                <datalist id="0" class="dataList"></datalist>
                <button onclick="AddDataOption(this)" style="display:block;">Add Data</button>
                Pages To Search: <button onclick="ToggleList(this)">Expand</button>
                <div id="pageList" class="pageList"></div>
                <h3>Sample View</h3>
                <table id="tableView">

                </table>
                <button onclick="RemoveOption(this)" id="lastDataPoint">Delete Option</button>
            </div>
            <button onclick="AddOption()" id="lastOption">Add new item option</button>
        </div>
        Global Pass Code: <input type="password" id="creationCode">
        Site Pass Code: <input type="password" id="siteCode">
        <button onclick="" id="lastOption">Add your site!</button>
        
    </div>
  </main>
  <script src="Loading.js"></script>
  <script>
    StartLoading("Loading...")
    Loaded()
    function GetChildByID(element, ID)
    {
        var children = element.children
        for (var i in children)
        {
            if (children[i].id == ID) return children[i]
        }
        return null
    }
    var siteSettings
    function UpdateAsideBox()
    {
        var panel = document.getElementById('object')
        panel.innerText = "Setting Object\n" + JSON.stringify(siteSettings)
    }
    function Reveal(str)
    {
        document.getElementById(str).style.display = 'initial'  
    }
    async function SetLink()
    {
        var linkElem = document.getElementById('link')
        var link = ""
        link = linkElem.value
        var httpsLoc = link.indexOf("https://")
        var fandomLoc = link.indexOf(".fandom.com")
        if (fandomLoc != -1) link = link.slice(0,fandomLoc)
        if (httpsLoc != -1) link = link.slice(httpsLoc+8)
        linkElem.value = link
        try {
            Restart("Checking Site Validity...")
            siteSettings = await Settings.Create(link)
            Loaded()
            document.getElementById('title').value = siteSettings.title
            linkElem.disabled = true
            Reveal('settings')
            UpdateAsideBox()
        }
        catch (err)
        {
            alert("Link was invalid " + link)
            console.error(err)
        }
    }
    function SetTitle()
    {
        if (!siteSettings)
        {
            alert("Select a site first.")
            return
        }
        siteSettings.SetTitle(document.getElementById('title').value)
        UpdateAsideBox()
    }
    var baseSetting = document.getElementById('baseSetting')
    var dataPoint = document.getElementById('baseDataPoint')
    var position = document.getElementById("lastOption")
    baseSetting.style.display = "none"
    var tableID = 1
    function AddOption()
    {
        var newSetting = baseSetting.cloneNode(true)
        newSetting.id = ""
        
        var divList = newSetting.getElementsByClassName('dataPoint')
        GetChildByID(newSetting, '0').id = tableID+'propList'
        console.log(divList)
        for (var i = 0; i < divList.length; i++)
        {
            var elem = GetChildByID(divList[i], 'dataLocation')
            elem.setAttribute('list', tableID + 'propList')
        }
        tableID++
        newSetting.style.display = "block"
        position.before(newSetting)
    }
    AddOption()
    function RemoveOption(button)
    {
        var id = button.parentNode.id
        if (id != "")
        {
            siteSettings.DeleteOption(id)
        }
        button.parentNode.remove()
        UpdateAsideBox()

    }
    function RemoveDataOption(button)
    {
        if (button.parentNode.id)
        {
            siteSettings.RemoveOptionPoint(button.parentNode.parentNode.id,button.parentNode.id)
        }
        button.parentNode.remove()
        UpdateAsideBox()
    }
    function AddDataOption(buttonPos)
    {
        var newPoint = dataPoint.cloneNode(true)
        var dataList = buttonPos.parentNode.getElementsByClassName('dataList')[0]
        GetChildByID(newPoint, 'dataLocation').setAttribute('list', dataList.id)
        buttonPos.before(newPoint)
        UpdateAsideBox()
    }

    function SetOptionName(input)
    {
        var oldid = input.parentNode.id
        var newid = input.value
        if (oldid == "") siteSettings.CreateOption(newid)
        else siteSettings.MoveOption(oldid, newid)
        input.parentNode.id = newid
        UpdateAsideBox()
    }

    function SetOptionSourcePage(input)
    {
        var id = input.parentNode.id
        if (!siteSettings.GetOption(id))
        {
            alert("Fill in name of item option first.")
        }
        else siteSettings.SetOptionPage(id, input.value)
        GetChildByID(input.parentNode, 'source_type').value = siteSettings.GetOption(id).source_type
        UpdateAsideBox()
    }

    function SetOptionSourceType(input)
    {
        var id = input.parentNode.id
        if (!siteSettings.GetOption(id))
        {
            alert("Fill in name of item option first.")
        }
        else siteSettings.SetOptionType(id, input.value)
        GetChildByID(input.parentNode, 'source_page').value = siteSettings.GetOption(id).source_page
        UpdateAsideBox()
    }

    var tableData = {}
    
    class Types
    {
        static number = "([0-9|\.|\,]+)" 
        static text = "(.*)" 
        static wrapped = ">(.*)<" 
    }

    function AddPropOptions(listElement, pageInfo)
    {
        var propList = []
        for (var i in pageInfo)
        {
            var propertyData = JSON.parse(pageInfo[i].parse.properties[0]["*"])[0].data
            for (var j in propertyData)
            {
                if (!propList.includes(propertyData[j].data.source))
                {
                    var optionNode = document.createElement('option')
                    optionNode.innerText = propertyData[j].data.source
                    listElement.appendChild(optionNode)
                    propList.push(propertyData[j].data.source)
                }
            }
            
        }
    }

    function LoadOptionStats(button)
    {
        var id = button.parentNode.id
        Restart("Getting Option Display Data")
        siteSettings.LoadOptionData(id).then(
            (data) =>
            {
                GetChildByID(button.parentNode, "pageList").innerText = JSON.stringify(data.pageList)
                var dataList = button.parentNode.getElementsByClassName('dataList')[0]
                AddPropOptions(dataList, data.pageInfo)
                tableData[id] = data.pageInfo
            }
        )
        .catch((err) => alert(err))
        .finally(Loaded())
    }

    function ToggleList(button)
    {
        var elem = GetChildByID(button.parentNode, "pageList")
        elem.style.height = (elem.style.height == "") ? "auto":""
    }

    function GetData(type, page, dataPoint)
    {
        if (type == 'properties')
        {
            var propertyData = JSON.parse(page.parse.properties[0]["*"])[0].data
            var data = propertyData.find((value) => {return value.data.source == dataPoint.location})
            if (data == null) {
                if (dataPoint.required) return null
                else return dataPoint.default
            }
            
            data = data.data.value.match(Types[dataPoint.type])[1]
            if (dataPoint.type == 'number') data = Number.parseFloat(data.replace("\,\g",""))
            return data
        }
        else if (type == 'page_templates')
        {
            var pageData = page.parse.wikitext['*']
            var data = pageData.match("\\|"+dataPoint.location+"\\s?=\\s?([^\x7C\\n}]+)(?:\x7C|\\n|}})")[1]
            if (data == '') {
                if (dataPoint.required) return null
                else return dataPoint.default
            }

            if (dataPoint.type == "number") data = Number.parseFloat(data.replace("\,\g",""))
            foundData[dataPoint.displayName] = data

        }
    }

    function UpdateTable(tableParent)
    {
        var table = GetChildByID(tableParent, 'tableView')
        const id = tableParent.id
        console.log(id)
        table.innerHTML = ''
        
        var option = siteSettings.GetOption(id)
        var row = document.createElement('tr')
        var itemNameTH = document.createElement('th')
        itemNameTH.innerHTML = 'Page'
        row.appendChild(itemNameTH)
        var tableRows = []
        for (var i in tableData[id])
        {
            var irow = document.createElement('tr')
            var itemNameTH = document.createElement('th')
            itemNameTH.className = 'itemColumn'
            itemNameTH.innerHTML = tableData[id][i].parse.title
            irow.appendChild(itemNameTH)
            tableRows.push(irow)
            table.append(irow)
        }
        for (var data_type in option.array_data)
        {
            var dataArray = option.array_data[data_type]
            for (var key in dataArray)
            {
                var name = dataArray[key].displayName
                var dataTH = document.createElement('th')
                dataTH.innerText = name
                row.appendChild(dataTH)
                for (var i in tableData[id])
                {
                    var dataTD = document.createElement('td')
                    var val = GetData(data_type, tableData[id][i], dataArray[key])
                    dataTD.innerHTML = val
                    tableRows[i].appendChild(dataTD)
                    if (val == null) tableRows[i].style.display = 'none'
                }
            }
            table.prepend(row)
        }
    }

    function SetDataPoint(inputBox)
    {
        var OptionID = inputBox.parentNode.id
        var oldid = inputBox.id
        var newid = GetChildByID(inputBox,'displayName').value
        var locationType = GetChildByID(inputBox,'dataLocationType').value
        var location = GetChildByID(inputBox,'dataLocation').value
        var required = GetChildByID(inputBox,'dataRequired').checked
        var defaultVal = GetChildByID(inputBox,'dataDefault').value
        var dataType = GetChildByID(inputBox,'dataType').value

        siteSettings.EditDataPoint(OptionID, oldid, {
            displayName:newid,
            location:location,
            locationType:locationType,
            default:defaultVal,
            type:dataType,
            required:required
        })
        inputBox.id = newid
        UpdateTable(inputBox.parentNode)
        UpdateAsideBox()
    }

    function SetDataPointParam()
    {
        UpdateAsideBox()
    }
  </script>
</body>

</html>