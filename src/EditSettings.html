<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <title>Editing Settings</title>
  <script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const linkParam = urlParams.get('site');
  </script>
  <script src="SettingObject.js"></script>
</head>

<body>
  <script src="Header.js"></script>
<aside class="viewWindow" id="object" style="word-wrap: break-word;">
Setting Object
</aside>
  <main>
    <h1>Site Settings</h1>
    <div id="main" style="border: 2px black solid; text-align: center;">
        <h1>Create Settings for your Fandom Site!</h1>
        <input type="text" id="link" title="Site Link" onchange="SetLink()">
        <div id = "settings">
            <h2>What would you like the visible name to be?</h2>
            <input type="text" id="title" title="Site Title" onchange="SetTitle()">
            <br><br>
            <div class="option" style="border: 1px black solid;" id="baseSetting">
                Name of item: <input type="text" id="optionName" onchange="SetOptionName(this)"><br>
                Page to get Option Data From: <input type="text" id="source_page" onchange="SetOptionSourcePage(this)"><br>
                Type of Page: <select id="source_type" onchange="SetOptionSourceType(this)">
                    <option value="Page_Links">Links on Page</option>
                    <option value="Category">Category Listing</option>
                </select><br>
                <div class="dataPoint" style="background-color: lightcoral; border-radius: 30px; display: inline-block;" id ="baseDataPoint">
                    Data Name: <input type="text" id="displayName" onchange="SetDataPoint(this.parentNode)"><br>
                    Location Of Data: <select id="dataLocationType" onchange="SetDataPoint(this.parentNode)">
                        <option value="properties">Property</option>
                        <option value="page_templates">Template</option>
                    </select><br>
                    Location: <input type="text" id="dataLocation" onchange="SetDataPoint(this.parentNode)"><br>
                    Type of Data: <select id="dataType" onchange="SetDataPoint(this.parentNode)">
                        <option value="number">Number</option>
                        <option value="text">Text</option>
                        <option value="wrapped">Wrapped</option>
                    </select><br>
                    Required?: <input type="checkbox" id="dataRequired" checked onchange="SetDataPoint(this.parentNode)">
                    Default Data Value: <input type="text" id="dataDefault" onchange="SetDataPoint(this.parentNode)"><br>
                    <button onclick="RemoveDataOption(this)">Delete Data Point</button>
                </div>
                <button onclick="AddDataOption(this)" style="display:block;">Add Data</button>
                <h3>Sample View</h3>
                <table>

                </table>
                <button onclick="RemoveOption(this)" id="lastDataPoint">Delete Option</button>
            </div>
            <button onclick="AddOption()" id="lastOption">Add new item option</button>
        </div>
    </div>
  </main>
  <script src="Loading.js"></script>
  <script>
    StartLoading("Loading...")
    Loaded()
    function GetChildByID(element, ID)
    {
        var children = element.children
        for (var i in children)
        {
            if (children[i].id == ID) return children[i]
        }
        return null
    }
    var siteSettings
    function UpdateAsideBox()
    {
        var panel = document.getElementById('object')
        panel.innerText = "Setting Object\n" + JSON.stringify(siteSettings)
    }
    function Reveal(str)
    {
        document.getElementById(str).style.display = 'initial'  
    }
    async function SetLink()
    {
        var linkElem = document.getElementById('link')
        var link = ""
        link = linkElem.value
        var httpsLoc = link.indexOf("https://")
        var fandomLoc = link.indexOf(".fandom.com")
        if (fandomLoc != -1) link = link.slice(0,fandomLoc)
        if (httpsLoc != -1) link = link.slice(httpsLoc+8)
        linkElem.value = link
        try {
            Restart("Checking Site Validity...")
            siteSettings = await Settings.Create(link)
            Loaded()
            document.getElementById('title').value = siteSettings.title
            linkElem.disabled = true
            Reveal('settings')
            UpdateAsideBox()
        }
        catch (err)
        {
            alert("Link was invalid " + link)
            console.error(err)
        }
    }
    function SetTitle()
    {
        if (!siteSettings)
        {
            alert("Select a site first.")
            return
        }
        siteSettings.SetTitle(document.getElementById('title').value)
        UpdateAsideBox()
    }
    var baseSetting = document.getElementById('baseSetting')
    var dataPoint = document.getElementById('baseDataPoint')
    var position = document.getElementById("lastOption")
    baseSetting.style.display = "none"
    function AddOption()
    {
        var newSetting = baseSetting.cloneNode(true)
        newSetting.id = ""
        newSetting.style.display = "block"
        position.before(newSetting)
    }
    AddOption()
    function RemoveOption(button)
    {
        var id = button.parentNode.id
        if (id != "")
        {
            siteSettings.DeleteOption(id)
        }
        button.parentNode.remove()
        UpdateAsideBox()

    }
    function RemoveDataOption(button)
    {
        if (button.parentNode.id)
        {
            siteSettings.RemoveOptionPoint(button.parentNode.parentNode.id,button.parentNode.id)
        }
        button.parentNode.remove()
        UpdateAsideBox()
    }
    function AddDataOption(buttonPos)
    {
        var newPoint = dataPoint.cloneNode(true)
        buttonPos.before(newPoint)
        UpdateAsideBox()
    }

    function SetOptionName(input)
    {
        var oldid = input.parentNode.id
        var newid = input.value
        if (oldid == "") siteSettings.CreateOption(newid)
        else siteSettings.MoveOption(oldid, newid)
        input.parentNode.id = newid
        UpdateAsideBox()
    }

    function SetOptionSourcePage(input)
    {
        var id = input.parentNode.id
        if (!siteSettings.GetOption(id))
        {
            alert("Fill in name of item option first.")
        }
        else siteSettings.SetOptionPage(id, input.value)
        GetChildByID(input.parentNode, 'source_type').value = siteSettings.GetOption(id).source_type
        UpdateAsideBox()
    }

    function SetOptionSourceType(input)
    {
        var id = input.parentNode.id
        if (!siteSettings.GetOption(id))
        {
            alert("Fill in name of item option first.")
        }
        else siteSettings.SetOptionType(id, input.value)
        GetChildByID(input.parentNode, 'source_page').value = siteSettings.GetOption(id).source_page
        UpdateAsideBox()
    }

    function SetDataPoint(inputBox)
    {
        var OptionID = inputBox.parentNode.id
        var oldid = inputBox.id
        var newid = GetChildByID(inputBox,'displayName').value
        var locationType = GetChildByID(inputBox,'dataLocationType').value
        var location = GetChildByID(inputBox,'dataLocation').value
        var required = GetChildByID(inputBox,'dataRequired').checked
        var defaultVal = GetChildByID(inputBox,'dataDefault').value
        var dataType = GetChildByID(inputBox,'dataType').value

        siteSettings.EditDataPoint(OptionID, oldid, {
            displayName:newid,
            location:location,
            locationType:locationType,
            default:defaultVal,
            type:dataType,
            required:required
        })
        inputBox.id = newid
        UpdateAsideBox()
    }

    function SetDataPointParam()
    {
        UpdateAsideBox()
    }
  </script>
</body>

</html>