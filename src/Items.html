<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <title>Item Info</title>
</head>

<body>
  <header><a href="/"></a></header>
  <aside id="ToggleBox" class="viewWindow">
    <select onchange="SortChange()" id="sort">
      <option value="none">None</option>
    </select>
    Ascending?<input onchange="SortChange()" type="checkbox" id="sortDirection">
    <br><br>
  </aside>
  <main>
    <h1 id = "siteHead"></h1>
    <table id="itemTable"></table>
  </main>
  <script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const linkParam = urlParams.get('site');
    const itemParam = urlParams.get('item');
    var table = document.getElementById('itemTable')
    var tableData = []
    var items = []

    function moveItems()
    {
      for (let i = 0; i < items.length; i++)
      {
        table.append(items[i].rowPointer)
      }
    }

    function sortItems(value, ascending)
    {
      items.sort(function (a,b){
        return (a[value] - b[value])*ascending
      })
    }
    function SortChange()
    {
      var sortVal = document.getElementById("sort").value
      var dir = -1
      if (document.getElementById("sortDirection").checked) dir = 1
      if (sortVal != "none")
      {
        sortItems(sortVal, dir)
        moveItems()
      }
    }

		function toggleColumn(columnIndex) {
			var column = table.getElementsByClassName(columnIndex);
			for (var i = 0; i < column.length; i++) {
				if (column[i].style.display === "none") {
					column[i].style.display = "table-cell";
				} else {
					column[i].style.display = "none";
				}
			}
		}

    function ToggleButton(colName)
    {
      var aside = document.getElementById("ToggleBox")

      var toggle = document.createElement("input")
      toggle.type = 'checkbox'
      toggle.checked = true

      toggle.addEventListener('change', function() {toggleColumn(colName)})

      aside.append(toggle)
      aside.append(colName)
      aside.append(document.createElement("br"))
    }

    fetch("https://createwikigatheringsettings.azurewebsites.net/api/ViewSettings?site="+linkParam).then(
        result => result.json().then(
            jsonData => {
              var option = jsonData.options[itemParam]
              var row = document.createElement('tr')
              var itemNameTH = document.createElement('th')
              itemNameTH.className = 'itemColumn'
              itemNameTH.innerHTML = 'Page'
              row.appendChild(itemNameTH)
              for (var data_type in option.array_data)
              {
                var dataArray = option.array_data[data_type]
                for (var key in dataArray)
                {
                  var name = dataArray[key].displayName
                  tableData.push(name)
                  var dataTH = document.createElement('th')
                  dataTH.className = name
                  dataTH.innerHTML = name
                  row.appendChild(dataTH)

                  ToggleButton(name)

                  var sortOption = document.createElement("option")
                  sortOption.innerHTML = name
                  sortOption.value = name
                  document.getElementById('sort').append(sortOption)
                }
                table.prepend(row)
              }
              return
            }
        ))
    .then(
      fetch("https://createwikigatheringsettings.azurewebsites.net/api/GetItemData?site="+linkParam+"&item="+itemParam).then(
        result => result.json().then(
            jsonData => {
              for (var itemName in jsonData)
              {
                var row = document.createElement('tr')
                var itemNameTH = document.createElement('th')
                itemNameTH.className = 'itemColumn'
                itemNameTH.innerHTML = itemName
                row.appendChild(itemNameTH)
                for (var key in tableData)
                {
                  var dataTD = document.createElement('td')
                  dataTD.className = tableData[key]
                  dataTD.innerHTML = jsonData[itemName][tableData[key]]
                  row.appendChild(dataTD)
                }
                items.push({...jsonData[itemName], rowPointer: row})
                table.append(row)
              }
            }
        ))
        )
    
  </script>
</body>

</html>