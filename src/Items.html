<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <title>Item Info</title>
</head>

<body>
  <script src="Header.js"></script>
  <aside id="ToggleBox" class="viewWindow">
    <select onchange="SortChange()" id="sort">
      <option value="none">None</option>
    </select>
    Ascending?<input onchange="SortChange()" type="checkbox" id="sortDirection">
    <br><br>
  </aside>
  <main>
    <h1 id = "siteHead"></h1>
    <table id="itemTable"></table>
  </main>
  <script src="Loading.js"></script>
  <script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const linkParam = urlParams.get('site');
    const itemParam = urlParams.get('item');
    var table = document.getElementById('itemTable')
    var tableData = []
    var items = []

    function moveItems()
    {
      for (let i = 0; i < items.length; i++)
      {
        table.append(items[i].rowPointer)
      }
    }

    function sortItems(value, ascending)
    {
      items.sort(function (a,b){
        return ((a[value] < b[value]) == ascending) ? -1:1
        
      })
    }
    function SortChange()
    {
      var sortVal = document.getElementById("sort").value
      if (sortVal != "none")
      {
        sortItems(sortVal, document.getElementById("sortDirection").checked)
        moveItems()
      }
    }

		function toggleColumn(columnIndex) {
			var column = table.getElementsByClassName(columnIndex);
			for (var i = 0; i < column.length; i++) {
				if (column[i].style.display === "none") {
					column[i].style.display = "table-cell";
				} else {
					column[i].style.display = "none";
				}
			}
		}

    function ToggleButton(colName)
    {
      var aside = document.getElementById("ToggleBox")

      var toggle = document.createElement("input")
      toggle.type = 'checkbox'
      toggle.checked = true

      toggle.addEventListener('change', function() {toggleColumn(colName)})

      aside.append(toggle)
      aside.append(colName)
      aside.append(document.createElement("br"))
    }
    var searchTerms = {}
    function SearchBy(row, value)
    {
      value = value.toLowerCase()
      for (var i = 0; i < items.length; i++)
      {
        if (items[i][row].toString().toLowerCase().includes(value)) items[i].rowPointer.style.display = ""
        else items[i].rowPointer.style.display = "none"
      }
    }

    function AddSearch(value)
    {
      var search = document.createElement('input')
      search.type = 'text'
      search.placeholder = "search/filter"
      search.addEventListener('change', ()=>{SearchBy(value, search.value)})
      search.size = 6
      return search
      
    }
    StartLoading("Fetching Layout Information...")
    fetch("https://createwikigatheringsettings.azurewebsites.net/api/ViewSettings?site="+linkParam).then(
        result => result.json().then(
            jsonData => {
              SetStatus("Setting Up Layout")

              document.getElementById("siteHead").append(jsonData.title + " " + itemParam)
              
              var option = jsonData.options[itemParam]
              var row = document.createElement('tr')
              var itemNameTH = document.createElement('th')
              itemNameTH.className = 'itemColumn'
              itemNameTH.innerHTML = 'Page'
              var search = AddSearch('name')
              itemNameTH.prepend(document.createElement('br'))
              itemNameTH.prepend(search)
              row.appendChild(itemNameTH)
              for (var data_type in option.array_data)
              {
                var dataArray = option.array_data[data_type]
                for (var key in dataArray)
                {
                  var name = dataArray[key].displayName
                  tableData.push(name)
                  var dataTH = document.createElement('th')
                  dataTH.className = name
                  dataTH.innerText = name

                  var search = AddSearch(name)
                  dataTH.prepend(document.createElement('br'))
                  dataTH.prepend(search)
                  row.appendChild(dataTH)

                  ToggleButton(name)

                  var sortOption = document.createElement("option")
                  sortOption.innerText = name
                  sortOption.value = name
                  document.getElementById('sort').append(sortOption)
                }
                table.prepend(row)
              }
              SetStatus("Fetching Item Data")
              return
            }
        ))
    .then(
      fetch("https://createwikigatheringsettings.azurewebsites.net/api/GetItemData?site="+linkParam+"&item="+itemParam).then(
        result => result.json().then(
            jsonData => {
              for (var itemName in jsonData)
              {
                SetStatus("Formatting Item Data")
                var row = document.createElement('tr')
                var itemNameTH = document.createElement('th')
                itemNameTH.className = 'itemColumn'
                itemNameTH.innerHTML = itemName
                row.appendChild(itemNameTH)
                for (var key in tableData)
                {
                  var dataTD = document.createElement('td')
                  dataTD.className = tableData[key]
                  dataTD.innerHTML = jsonData[itemName][tableData[key]]
                  row.appendChild(dataTD)
                }
                items.push({...jsonData[itemName], rowPointer: row})
                table.append(row)
              }
              Loaded()
            }
        ))
        )
    
  </script>
</body>

</html>